import{d as k,r as Pt,w as _}from"./entry.DOFx4R7E.js";import{p as y}from"./stores.C0u502qJ.js";import{t as A}from"./translate.BBe5dcco.js";import{v as rt,C as h}from"./scheduler.9nPpm2FE.js";import{r as E,a as w,i as it,b as It,p as Tt,c as _t,d as gt,e as At,m as O}from"./route-for-api.ChdCJBUD.js";import{A as x}from"./workflow-actions.TBME1SPK.js";import{b as St,c as xt,a as et}from"./decode-payload.CQMhVzRS.js";import{f as bt,g as Wt,h as Ct}from"./screaming-enums.w0zEi9dM.js";import{s as Lt,c as st,t as Y}from"./versions.BLkPrIJY.js";import{s as Rt}from"./index.B7Q76-bx.js";import{a as $}from"./auth-user.CO1jhKYI.js";import{h as Yt}from"./events.CIGgYyM7.js";import{e as b,s as pt}from"./encode-payload.FX6UMOnd.js";import{p as Nt}from"./paginated.B9c9dQhg.js";import{s as P}from"./parse-with-big-int.DJQKqIvA.js";import{i as Dt,c as Ot,d as at,e as $t}from"./format-time.-q8QuKs5.js";import{a as Ut}from"./events-service.NOGP8jXr.js";import{v as Ft}from"./toaster.B6V5Bvc6.js";const Bt=async(t,o,n=fetch)=>{let r=0;try{const e=E("workflows.count",{namespace:t}),a=await w(e,{params:o?{query:o}:{},onError:rt,handleError:rt,request:n});r=parseInt((a==null?void 0:a.count)||"0")}catch{}return{count:r}},Uo=async({namespace:t,query:o})=>{const n="GROUP BY ExecutionStatus",r=E("workflows.count",{namespace:t}),{count:e,groups:a}=await w(r,{params:{query:o?`${o} ${n}`:`${n}`},notifyOnError:!1});return{count:e??"0",groups:a}},Fo=async({namespace:t})=>{const o='TemporalNamespaceDivision="TemporalScheduler" AND ExecutionStatus="Running"',n=E("workflows.count",{namespace:t}),{count:r}=await w(n,{params:{query:o},notifyOnError:!1});return r??"0"},qt=(t=Lt)=>!h(t).disableWriteActions,vt=(t=[])=>t.map(o=>{const n=Rt(o,!0),r=o.activityId;return{...n,id:r}}),Vt=t=>t?t.map(o=>({...o,state:Wt(o.state)})):[],Qt=t=>t?t.map(o=>({...o,state:Ct(o.state)})):[],Gt=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((n,[r,e])=>({...n,[r]:St(e)}),{})},U=t=>{var V,Q,G,z,X,j,M,K,H,J,Z,tt,ot,nt;const o=Gt(t.workflowExecutionInfo.searchAttributes),n=t.workflowExecutionInfo.memo,r=t.workflowExecutionInfo.type.name,e=t.workflowExecutionInfo.execution.workflowId,a=t.workflowExecutionInfo.execution.runId,i=t.workflowExecutionInfo.startTime,c=t.workflowExecutionInfo.closeTime,s=t.workflowExecutionInfo.executionTime,l=bt(t.workflowExecutionInfo.status),f=l==="Running",d=t.workflowExecutionInfo.historyLength,u=t.workflowExecutionInfo.historySizeBytes,m=`/workflows/${e}/${a}`,I=((Q=(V=t==null?void 0:t.executionConfig)==null?void 0:V.taskQueue)==null?void 0:Q.name)||((G=t==null?void 0:t.workflowExecutionInfo)==null?void 0:G.taskQueue),S=(z=t==null?void 0:t.workflowExecutionInfo)==null?void 0:z.mostRecentWorkerVersionStamp,g=(X=t==null?void 0:t.workflowExecutionInfo)==null?void 0:X.assignedBuildId,W=(j=t==null?void 0:t.workflowExecutionInfo)==null?void 0:j.parentNamespaceId,C=(M=t==null?void 0:t.workflowExecutionInfo)==null?void 0:M.parentExecution,B=t.workflowExecutionInfo.stateTransitionCount,T=(K=t.executionConfig)==null?void 0:K.defaultWorkflowTaskTimeout,wt=vt(t.pendingActivities),Et=(t==null?void 0:t.pendingChildren)??[],mt=Vt(t==null?void 0:t.pendingNexusOperations),kt=t==null?void 0:t.pendingWorkflowTask,ht=Qt(t==null?void 0:t.callbacks),yt=(H=t.workflowExecutionInfo)==null?void 0:H.rootExecution;let q,v;return(J=t==null?void 0:t.executionConfig)!=null&&J.userMetadata&&(q=(tt=(Z=t==null?void 0:t.executionConfig)==null?void 0:Z.userMetadata)==null?void 0:tt.summary,v=(nt=(ot=t==null?void 0:t.executionConfig)==null?void 0:ot.userMetadata)==null?void 0:nt.details),{name:r,id:e,runId:a,startTime:i,endTime:c,executionTime:s,status:l,historyEvents:d,historySizeBytes:u,searchAttributes:o,memo:n,rootExecution:yt,url:m,taskQueue:I,assignedBuildId:g,mostRecentWorkerVersionStamp:S,pendingActivities:wt,pendingChildren:Et,pendingNexusOperations:mt,pendingWorkflowTask:kt,callbacks:ht,summary:q,details:v,parentNamespaceId:W,parent:C,stateTransitionCount:B,isRunning:f,defaultWorkflowTaskTimeout:T,get canBeTerminated(){return f&&qt()}}},p=t=>(t.executions||[]).map(o=>U({workflowExecutionInfo:o})),zt=(t,o)=>{var n;return((n=t==null?void 0:t.visibilityStore)==null?void 0:n.includes("elasticsearch"))||it(o,"1.19")},Xt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},N=k([y],([t])=>{var o,n,r;return(r=(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),ct=k([st,Y,N],([t,o,n])=>zt(t,o)||n);k([st,N],([t,o])=>Xt(t)||o);var L=(t=>(t[t.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL=1]="RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL",t[t.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE=2]="RESET_REAPPLY_EXCLUDE_TYPE_UPDATE",t))(L||{}),R=(t=>(t[t.RESET_REAPPLY_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_TYPE_SIGNAL=1]="RESET_REAPPLY_TYPE_SIGNAL",t[t.RESET_REAPPLY_TYPE_NONE=2]="RESET_REAPPLY_TYPE_NONE",t[t.RESET_REAPPLY_TYPE_ALL_ELIGIBLE=3]="RESET_REAPPLY_TYPE_ALL_ELIGIBLE",t))(R||{});const jt={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Mt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Kt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Ht=t=>{if(typeof t!="string")return!1;for(const o of Mt)if(o===t)return!0;return!1},Jt=(t,o,n)=>{const r=jt[t];return o==="All"?"":Dt(o)||Ot(o)?n||h(ct)?`${r} > "${at(o)}"`:`${r} BETWEEN "${at(o)}" AND "${$t()}"`:`${r}="${o}"`},Zt=(t,o)=>Object.entries(t).map(([n,r])=>{if(Ht(n)&&Kt(r))return Jt(n,r,o)}).filter(Boolean),ut=(t,o=!1)=>Zt(t,o).join(" and ");function to(t){console.error("Unhandled action:",t)}const oo=(t,o)=>{let n;switch(t){case x.Cancel:n=A("workflows.canceled");break;case x.Reset:n=A("workflows.reset");break;case x.Terminate:n=A("workflows.terminated");break;default:to(t)}return o?A("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:o}):A("workflows.workflow-action-reason-placeholder",{action:n})},lt=({action:t,reason:o,email:n})=>{const r=oo(t,n);return o?[o.trim(),r].join(" "):r},F=async(t,o,n=fetch,r=!1)=>{const e=o.query||ut(o,r);let a;try{a=decodeURIComponent(e)}catch{a=e}const i=r?"workflows.archived":"workflows";let c="";const s=u=>{var m,I;_t(u),(m=u==null?void 0:u.body)!=null&&m.message||u!=null&&u.status?c=((I=u==null?void 0:u.body)==null?void 0:I.message)??`Error fetching workflows: ${u.status}: ${u.statusText}`:c="Error fetching workflows: Server failed to respond"},l=E(i,{namespace:t}),{executions:f,nextPageToken:d}=await w(l,{params:{query:a},onError:s,handleError:s,request:n})??{executions:[],nextPageToken:""};return{workflows:p({executions:f}),nextPageToken:String(d),error:c}},Bo=async({namespace:t,workflowId:o,url:n},r=fetch)=>{var f;const e="workflows",a=n??It(t),i=Tt(e,{namespace:t}),c=a+i,{executions:s}=await w(c,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:r})??{executions:[]},l=(f=p({executions:s}))==null?void 0:f[0];return{runId:l==null?void 0:l.runId}},qo=async(t,o=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const a=c=>{(gt(c)||At(c))&&(e=!1)},i=E(r,{namespace:t});return await w(i,{params:{pageSize:"1"},onError:a,handleError:a,request:o}),{authorized:e}},vo=async(t,o,n=fetch)=>F(t,o,n,!0);async function ft(t,o=fetch){const n=E("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(n,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(r=>({workflow:U(r)})).catch(r=>({error:r}))}async function Vo({workflow:t,namespace:o,reason:n}){const r=E("workflow.terminate",{namespace:o,workflowId:t.id}),e=h($).email,a=lt({reason:n,action:x.Terminate,email:e});return await w(r,{options:{method:"POST",body:P({reason:a,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Qo({namespace:t,workflow:{id:o,runId:n}},r=fetch){const e=E("workflow.cancel",{namespace:t,workflowId:o});return w(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Go({namespace:t,workflow:{id:o,runId:n},name:r,input:e,encoding:a}){const i=E("workflow.signal",{namespace:t,workflowId:o,signalName:r}),c=await b(e,a),s=h(y).data.settings,l=(s==null?void 0:s.version)??"",d=it(l,"2.22")?{signalName:r,workflowExecution:{workflowId:o,runId:n},input:{payloads:c}}:{signalName:r,input:{payloads:c},params:{"execution.runId":n}};return w(i,{notifyOnError:!1,options:{method:"POST",body:P(d)}})}async function zo({namespace:t,workflow:{workflowId:o,runId:n},name:r,identity:e,updateId:a,input:i="",encoding:c}){const s=E("workflow.update",{namespace:t,workflowId:o,updateName:r}),l=await b(i,c);return w(s,{notifyOnError:!1,options:{method:"POST",body:P({workflowExecution:{runId:n},request:{meta:{updateId:a,identity:e},input:{args:{payloads:l}}}})}})}async function Xo({namespace:t,workflow:{id:o,runId:n},eventId:r,reason:e,includeSignals:a,excludeSignals:i,excludeUpdates:c}){const s=E("workflow.reset",{namespace:t,workflowId:o}),l=h($).email,f=lt({action:x.Reset,reason:e,email:l}),d={workflowExecution:{workflowId:o,runId:n},workflowTaskFinishEventId:r,requestId:Ft(),reason:f};if(h(N)||O("1.24.0",h(Y))){const u=[];!i&&!c&&u.push(L.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED),i&&u.push(L.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL),c&&u.push(L.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE),d.resetReapplyExcludeTypes=u,d.resetReapplyType=R.RESET_REAPPLY_TYPE_ALL_ELIGIBLE}else{let u;a?u=R.RESET_REAPPLY_TYPE_SIGNAL:u=R.RESET_REAPPLY_TYPE_NONE,d.resetReapplyType=u}return w(s,{notifyOnError:!1,options:{method:"POST",body:P(d)},params:{"execution.runId":n}})}async function jo(t,o=fetch){const n=e=>{console.error(e)},r=E("workflow",t);return w(r,{request:o,onError:n,handleError:n}).then(U)}async function Mo(t,o,n){if(!h(dt))return[];try{let r=`ParentWorkflowId = "${o}"`;n&&(r+=` AND ParentRunId = "${n}"`);const{workflows:e}=await F(t,{query:r});return e}catch{return[]}}const no=t=>{if(!t.length)return{};const o={};return t.forEach(n=>{o[n.label]=pt(n.value)}),o};async function Ko({namespace:t,workflowId:o,taskQueue:n,workflowType:r,input:e,summary:a,details:i,encoding:c,searchAttributes:s}){const l=E("workflow",{namespace:t,workflowId:o});let f,d,u;if(e)try{f=await b(e,c)}catch{throw new Error("Could not encode input for starting workflow")}try{a&&(d=(await b(P(a),"json/plain"))[0]),i&&(u=(await b(P(i),"json/plain"))[0])}catch{console.error("Could not encode summary or details for starting workflow")}const m=P({workflowId:o,taskQueue:{name:n},workflowType:{name:r},input:f?{payloads:f}:null,userMetadata:{summary:d,details:u},searchAttributes:s.length===0?null:{indexedFields:{...no(s)}}});return w(l,{notifyOnError:!1,options:{method:"POST",body:m}})}const Ho=async({namespace:t,workflowType:o,workflowId:n})=>{var a,i,c;const r=s=>{console.error(s)},e={input:"",searchAttributes:void 0,summary:"",details:""};try{let s="";o&&n?s=`WorkflowType = "${o}" AND WorkflowId = "${n}"`:o?s=`WorkflowType = "${o}"`:n&&(s=`WorkflowId = "${n}"`);const l=E("workflows",{namespace:t}),f=await w(l,{params:{query:s,pageSize:"1"},handleError:r});if(!((a=f==null?void 0:f.executions)!=null&&a[0]))return e;const d=p(f)[0],u={namespace:t,workflowId:d.id,runId:d.runId},{workflow:m}=await ft(u),S=await Ut(u),g=await xt((i=S==null?void 0:S.attributes)==null?void 0:i.input,t,h(y).data.settings,h($).accessToken);let W="";if(m.summary){const T=await et(m.summary);typeof T=="string"&&(W=T)}let C="";if(m.details){const T=await et(m.details);typeof T=="string"&&(C=T)}return{input:g!=null&&g.payloads?P(g.payloads[0]):"",searchAttributes:(c=m==null?void 0:m.searchAttributes)==null?void 0:c.indexedFields,summary:W,details:C}}catch{return e}},ro=(t,o)=>{const n=new Map;o.forEach(e=>{if(e.parent){const a=`${e.parent.workflowId}:${e.parent.runId}`,i=n.get(a)||[];i.push(e),n.set(a,i)}});const r=(e,a)=>{const i=`${e.id}:${e.runId}`,c=n.get(i)||[],s={workflow:e,children:[],rootPaths:[...a,{runId:e.runId,workflowId:e.id}]};return s.children=c.map(l=>r(l,s.rootPaths)),s};return r(t,[])};async function Jo(t,o,n){let r=`RootWorkflowId = "${o}"`;n&&(r+=` AND RootRunId = "${n}"`);const e=await ft({namespace:t,workflowId:o,runId:n}),a=await eo(t,{query:r});return ro(e==null?void 0:e.workflow,a)}const eo=async(t,o,n=fetch,r=!1)=>{const e=o.query||ut(o,r);let a;try{a=decodeURIComponent(e)}catch{a=e}const i=E("workflows",{namespace:t}),{executions:c}=await Nt(async s=>w(i,{token:s,request:n,params:{query:a}}));return p({executions:c})},ao=300,io=async(t,o,n)=>{o.set(!0);try{await n()}catch(r){console.error(r)}t.set(!1),setTimeout(()=>{o.set(!1)},ao)},so=k([y],([t])=>{var o,n,r;return!!((r=(n=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:n.capabilities)!=null&&r.countGroupByExecutionStatus)}),Zo=k([y,Y],([t,o])=>{var e,a,i;const n=O("1.23.0",o),r=!!((i=(a=(e=t.data)==null?void 0:e.systemInfo)==null?void 0:a.capabilities)!=null&&i.prefixSearch);return n||r}),co=_(0),uo=k([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.hideWorkflowQueryErrors}),tn=k([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.refreshWorkflowCountsDisabled}),dt=k([N,Y],([t,o])=>t||O("1.23.0",o)),lo=k([y],([t])=>t.url.searchParams.get("query")),fo=k([lo,dt,Yt],([t,o,n])=>o&&n&&!t?"ParentWorkflowId is NULL":t),wo=k([y],([t])=>t.params.namespace),Eo=k([wo,fo,co,ct,uo],([t,o,n,r,e])=>({namespace:t,query:o,refresh:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})),mo=t=>{Po.set({...t,newCount:0})},ko=t=>Eo.subscribe(({namespace:o,query:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})=>{io(yo,ho,async()=>{const{workflows:a,error:i}=await F(o,{query:n});if(t(a),r&&!h(so)){const c=await Bt(o,n);mo(c)}i?e?D.set(A("workflows.workflows-error-querying")):D.set(i):D.set("")})}),on=_(""),ho=_(!0),yo=_(!0),Po=_({count:0,newCount:0}),D=_(""),nn=Pt([],ko),rn=_("");export{ft as A,rn as B,oo as C,yo as D,ho as E,D as F,nn as G,Zo as H,qo as a,Uo as b,on as c,tn as d,Ho as e,Bo as f,Ko as g,Qo as h,ct as i,Fo as j,N as k,qt as l,vo as m,ut as n,jo as o,so as p,fo as q,co as r,no as s,Vo as t,Mo as u,Jo as v,Po as w,Xo as x,Go as y,zo as z};
