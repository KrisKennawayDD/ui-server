import{d as k,r as yt,w as _}from"./entry.C6mbzFRA.js";import{p as y}from"./stores.D_RZK_XI.js";import{t as A}from"./translate.BBe5dcco.js";import{r as E,a as w,i as at,b as Pt,p as It,c as Tt,d as _t,e as gt,m as O}from"./route-for-api.BXbKDHZt.js";import{C as h}from"./scheduler.BIAblxOX.js";import{A as x}from"./workflow-actions.TBME1SPK.js";import{b as At,c as St,a as rt}from"./decode-payload.B5GxTJLa.js";import{f as xt,g as bt,h as Wt}from"./screaming-enums.w0zEi9dM.js";import{s as Ct,c as it,t as Y}from"./versions.CmC2nsWs.js";import{s as Lt}from"./index.p2jFq9Md.js";import{a as $}from"./auth-user.azyxyrGL.js";import{h as Rt}from"./events.C8cz-dNi.js";import{e as b,s as Yt}from"./encode-payload.MjjiyJ0j.js";import{p as pt}from"./paginated.BBe1njWA.js";import{s as P}from"./parse-with-big-int.DJQKqIvA.js";import{i as Nt,c as Dt,d as et,e as Ot}from"./format-time.-q8QuKs5.js";import{a as $t}from"./events-service.DUsCj6uZ.js";import{v as Ut}from"./toaster.DngqUeXw.js";const Ft=async(t,o,n=fetch)=>{let r=0;try{const e=E("workflows.count",{namespace:t}),a=await w(e,{params:o?{query:o}:{},onError:()=>{},handleError:()=>{},request:n});r=parseInt((a==null?void 0:a.count)||"0")}catch{}return{count:r}},$o=async({namespace:t,query:o})=>{const n="GROUP BY ExecutionStatus",r=E("workflows.count",{namespace:t}),{count:e,groups:a}=await w(r,{params:{query:o?`${o} ${n}`:`${n}`},notifyOnError:!1});return{count:e??"0",groups:a}},Uo=async({namespace:t})=>{const o='TemporalNamespaceDivision="TemporalScheduler" AND ExecutionStatus="Running"',n=E("workflows.count",{namespace:t}),{count:r}=await w(n,{params:{query:o},notifyOnError:!1});return r??"0"},Bt=(t=Ct)=>!h(t).disableWriteActions,qt=(t=[])=>t.map(o=>{const n=Lt(o,!0),r=o.activityId;return{...n,id:r}}),vt=t=>t?t.map(o=>({...o,state:bt(o.state)})):[],Vt=t=>t?t.map(o=>({...o,state:Wt(o.state)})):[],Qt=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((n,[r,e])=>({...n,[r]:At(e)}),{})},U=t=>{var V,Q,G,z,X,j,M,K,H,J,Z,tt,ot,nt;const o=Qt(t.workflowExecutionInfo.searchAttributes),n=t.workflowExecutionInfo.memo,r=t.workflowExecutionInfo.type.name,e=t.workflowExecutionInfo.execution.workflowId,a=t.workflowExecutionInfo.execution.runId,i=t.workflowExecutionInfo.startTime,c=t.workflowExecutionInfo.closeTime,s=t.workflowExecutionInfo.executionTime,l=xt(t.workflowExecutionInfo.status),f=l==="Running",d=t.workflowExecutionInfo.historyLength,u=t.workflowExecutionInfo.historySizeBytes,m=`/workflows/${e}/${a}`,I=((Q=(V=t==null?void 0:t.executionConfig)==null?void 0:V.taskQueue)==null?void 0:Q.name)||((G=t==null?void 0:t.workflowExecutionInfo)==null?void 0:G.taskQueue),S=(z=t==null?void 0:t.workflowExecutionInfo)==null?void 0:z.mostRecentWorkerVersionStamp,g=(X=t==null?void 0:t.workflowExecutionInfo)==null?void 0:X.assignedBuildId,W=(j=t==null?void 0:t.workflowExecutionInfo)==null?void 0:j.parentNamespaceId,C=(M=t==null?void 0:t.workflowExecutionInfo)==null?void 0:M.parentExecution,B=t.workflowExecutionInfo.stateTransitionCount,T=(K=t.executionConfig)==null?void 0:K.defaultWorkflowTaskTimeout,dt=qt(t.pendingActivities),wt=(t==null?void 0:t.pendingChildren)??[],Et=vt(t==null?void 0:t.pendingNexusOperations),mt=t==null?void 0:t.pendingWorkflowTask,kt=Vt(t==null?void 0:t.callbacks),ht=(H=t.workflowExecutionInfo)==null?void 0:H.rootExecution;let q,v;return(J=t==null?void 0:t.executionConfig)!=null&&J.userMetadata&&(q=(tt=(Z=t==null?void 0:t.executionConfig)==null?void 0:Z.userMetadata)==null?void 0:tt.summary,v=(nt=(ot=t==null?void 0:t.executionConfig)==null?void 0:ot.userMetadata)==null?void 0:nt.details),{name:r,id:e,runId:a,startTime:i,endTime:c,executionTime:s,status:l,historyEvents:d,historySizeBytes:u,searchAttributes:o,memo:n,rootExecution:ht,url:m,taskQueue:I,assignedBuildId:g,mostRecentWorkerVersionStamp:S,pendingActivities:dt,pendingChildren:wt,pendingNexusOperations:Et,pendingWorkflowTask:mt,callbacks:kt,summary:q,details:v,parentNamespaceId:W,parent:C,stateTransitionCount:B,isRunning:f,defaultWorkflowTaskTimeout:T,get canBeTerminated(){return f&&Bt()}}},p=t=>(t.executions||[]).map(o=>U({workflowExecutionInfo:o})),Gt=(t,o)=>{var n;return((n=t==null?void 0:t.visibilityStore)==null?void 0:n.includes("elasticsearch"))||at(o,"1.19")},zt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},N=k([y],([t])=>{var o,n,r;return(r=(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),st=k([it,Y,N],([t,o,n])=>Gt(t,o)||n);k([it,N],([t,o])=>zt(t)||o);var L=(t=>(t[t.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL=1]="RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL",t[t.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE=2]="RESET_REAPPLY_EXCLUDE_TYPE_UPDATE",t))(L||{}),R=(t=>(t[t.RESET_REAPPLY_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_TYPE_SIGNAL=1]="RESET_REAPPLY_TYPE_SIGNAL",t[t.RESET_REAPPLY_TYPE_NONE=2]="RESET_REAPPLY_TYPE_NONE",t[t.RESET_REAPPLY_TYPE_ALL_ELIGIBLE=3]="RESET_REAPPLY_TYPE_ALL_ELIGIBLE",t))(R||{});const Xt={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},jt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Mt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Kt=t=>{if(typeof t!="string")return!1;for(const o of jt)if(o===t)return!0;return!1},Ht=(t,o,n)=>{const r=Xt[t];return o==="All"?"":Nt(o)||Dt(o)?n||h(st)?`${r} > "${et(o)}"`:`${r} BETWEEN "${et(o)}" AND "${Ot()}"`:`${r}="${o}"`},Jt=(t,o)=>Object.entries(t).map(([n,r])=>{if(Kt(n)&&Mt(r))return Ht(n,r,o)}).filter(Boolean),ct=(t,o=!1)=>Jt(t,o).join(" and ");function Zt(t){console.error("Unhandled action:",t)}const to=(t,o)=>{let n;switch(t){case x.Cancel:n=A("workflows.canceled");break;case x.Reset:n=A("workflows.reset");break;case x.Terminate:n=A("workflows.terminated");break;default:Zt(t)}return o?A("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:o}):A("workflows.workflow-action-reason-placeholder",{action:n})},ut=({action:t,reason:o,email:n})=>{const r=to(t,n);return o?[o.trim(),r].join(" "):r},F=async(t,o,n=fetch,r=!1)=>{const e=o.query||ct(o,r);let a;try{a=decodeURIComponent(e)}catch{a=e}const i=r?"workflows.archived":"workflows";let c="";const s=u=>{var m,I;Tt(u),(m=u==null?void 0:u.body)!=null&&m.message||u!=null&&u.status?c=((I=u==null?void 0:u.body)==null?void 0:I.message)??`Error fetching workflows: ${u.status}: ${u.statusText}`:c="Error fetching workflows: Server failed to respond"},l=E(i,{namespace:t}),{executions:f,nextPageToken:d}=await w(l,{params:{query:a},onError:s,handleError:s,request:n})??{executions:[],nextPageToken:""};return{workflows:p({executions:f}),nextPageToken:String(d),error:c}},Fo=async({namespace:t,workflowId:o,url:n},r=fetch)=>{var f;const e="workflows",a=n??Pt(t),i=It(e,{namespace:t}),c=a+i,{executions:s}=await w(c,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:r})??{executions:[]},l=(f=p({executions:s}))==null?void 0:f[0];return{runId:l==null?void 0:l.runId}},Bo=async(t,o=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const a=c=>{(_t(c)||gt(c))&&(e=!1)},i=E(r,{namespace:t});return await w(i,{params:{pageSize:"1"},onError:a,handleError:a,request:o}),{authorized:e}},qo=async(t,o,n=fetch)=>F(t,o,n,!0);async function lt(t,o=fetch){const n=E("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(n,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(r=>({workflow:U(r)})).catch(r=>({error:r}))}async function vo({workflow:t,namespace:o,reason:n}){const r=E("workflow.terminate",{namespace:o,workflowId:t.id}),e=h($).email,a=ut({reason:n,action:x.Terminate,email:e});return await w(r,{options:{method:"POST",body:P({reason:a,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Vo({namespace:t,workflow:{id:o,runId:n}},r=fetch){const e=E("workflow.cancel",{namespace:t,workflowId:o});return w(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Qo({namespace:t,workflow:{id:o,runId:n},name:r,input:e,encoding:a}){const i=E("workflow.signal",{namespace:t,workflowId:o,signalName:r}),c=await b(e,a),s=h(y).data.settings,l=(s==null?void 0:s.version)??"",d=at(l,"2.22")?{signalName:r,workflowExecution:{workflowId:o,runId:n},input:{payloads:c}}:{signalName:r,input:{payloads:c},params:{"execution.runId":n}};return w(i,{notifyOnError:!1,options:{method:"POST",body:P(d)}})}async function Go({namespace:t,workflow:{workflowId:o,runId:n},name:r,identity:e,updateId:a,input:i="",encoding:c}){const s=E("workflow.update",{namespace:t,workflowId:o,updateName:r}),l=await b(i,c);return w(s,{notifyOnError:!1,options:{method:"POST",body:P({workflowExecution:{runId:n},request:{meta:{updateId:a,identity:e},input:{args:{payloads:l}}}})}})}async function zo({namespace:t,workflow:{id:o,runId:n},eventId:r,reason:e,includeSignals:a,excludeSignals:i,excludeUpdates:c}){const s=E("workflow.reset",{namespace:t,workflowId:o}),l=h($).email,f=ut({action:x.Reset,reason:e,email:l}),d={workflowExecution:{workflowId:o,runId:n},workflowTaskFinishEventId:r,requestId:Ut(),reason:f};if(h(N)||O("1.24.0",h(Y))){const u=[];!i&&!c&&u.push(L.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED),i&&u.push(L.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL),c&&u.push(L.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE),d.resetReapplyExcludeTypes=u,d.resetReapplyType=R.RESET_REAPPLY_TYPE_ALL_ELIGIBLE}else{let u;a?u=R.RESET_REAPPLY_TYPE_SIGNAL:u=R.RESET_REAPPLY_TYPE_NONE,d.resetReapplyType=u}return w(s,{notifyOnError:!1,options:{method:"POST",body:P(d)},params:{"execution.runId":n}})}async function Xo(t,o=fetch){const n=e=>{console.error(e)},r=E("workflow",t);return w(r,{request:o,onError:n,handleError:n}).then(U)}async function jo(t,o,n){if(!h(ft))return[];try{let r=`ParentWorkflowId = "${o}"`;n&&(r+=` AND ParentRunId = "${n}"`);const{workflows:e}=await F(t,{query:r});return e}catch{return[]}}const oo=t=>{if(!t.length)return{};const o={};return t.forEach(n=>{o[n.label]=Yt(n.value)}),o};async function Mo({namespace:t,workflowId:o,taskQueue:n,workflowType:r,input:e,summary:a,details:i,encoding:c,searchAttributes:s}){const l=E("workflow",{namespace:t,workflowId:o});let f,d,u;if(e)try{f=await b(e,c)}catch{throw new Error("Could not encode input for starting workflow")}try{a&&(d=(await b(P(a),"json/plain"))[0]),i&&(u=(await b(P(i),"json/plain"))[0])}catch{console.error("Could not encode summary or details for starting workflow")}const m=P({workflowId:o,taskQueue:{name:n},workflowType:{name:r},input:f?{payloads:f}:null,userMetadata:{summary:d,details:u},searchAttributes:s.length===0?null:{indexedFields:{...oo(s)}}});return w(l,{notifyOnError:!1,options:{method:"POST",body:m}})}const Ko=async({namespace:t,workflowType:o,workflowId:n})=>{var a,i,c;const r=s=>{console.error(s)},e={input:"",searchAttributes:void 0,summary:"",details:""};try{let s="";o&&n?s=`WorkflowType = "${o}" AND WorkflowId = "${n}"`:o?s=`WorkflowType = "${o}"`:n&&(s=`WorkflowId = "${n}"`);const l=E("workflows",{namespace:t}),f=await w(l,{params:{query:s,pageSize:"1"},handleError:r});if(!((a=f==null?void 0:f.executions)!=null&&a[0]))return e;const d=p(f)[0],u={namespace:t,workflowId:d.id,runId:d.runId},{workflow:m}=await lt(u),S=await $t(u),g=await St((i=S==null?void 0:S.attributes)==null?void 0:i.input,t,h(y).data.settings,h($).accessToken);let W="";if(m.summary){const T=await rt(m.summary);typeof T=="string"&&(W=T)}let C="";if(m.details){const T=await rt(m.details);typeof T=="string"&&(C=T)}return{input:g!=null&&g.payloads?P(g.payloads[0]):"",searchAttributes:(c=m==null?void 0:m.searchAttributes)==null?void 0:c.indexedFields,summary:W,details:C}}catch{return e}},no=(t,o)=>{const n=new Map;o.forEach(e=>{if(e.parent){const a=`${e.parent.workflowId}:${e.parent.runId}`,i=n.get(a)||[];i.push(e),n.set(a,i)}});const r=(e,a)=>{const i=`${e.id}:${e.runId}`,c=n.get(i)||[],s={workflow:e,children:[],rootPaths:[...a,{runId:e.runId,workflowId:e.id}]};return s.children=c.map(l=>r(l,s.rootPaths)),s};return r(t,[])};async function Ho(t,o,n){let r=`RootWorkflowId = "${o}"`;n&&(r+=` AND RootRunId = "${n}"`);const e=await lt({namespace:t,workflowId:o,runId:n}),a=await ro(t,{query:r});return no(e==null?void 0:e.workflow,a)}const ro=async(t,o,n=fetch,r=!1)=>{const e=o.query||ct(o,r);let a;try{a=decodeURIComponent(e)}catch{a=e}const i=E("workflows",{namespace:t}),{executions:c}=await pt(async s=>w(i,{token:s,request:n,params:{query:a}}));return p({executions:c})},eo=300,ao=async(t,o,n)=>{o.set(!0);try{await n()}catch(r){console.error(r)}t.set(!1),setTimeout(()=>{o.set(!1)},eo)},io=k([y],([t])=>{var o,n,r;return!!((r=(n=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:n.capabilities)!=null&&r.countGroupByExecutionStatus)}),Jo=k([y,Y],([t,o])=>{var e,a,i;const n=O("1.23.0",o),r=!!((i=(a=(e=t.data)==null?void 0:e.systemInfo)==null?void 0:a.capabilities)!=null&&i.prefixSearch);return n||r}),so=_(0),co=k([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.hideWorkflowQueryErrors}),Zo=k([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.refreshWorkflowCountsDisabled}),ft=k([N,Y],([t,o])=>t||O("1.23.0",o)),uo=k([y],([t])=>t.url.searchParams.get("query")),lo=k([uo,ft,Rt],([t,o,n])=>o&&n&&!t?"ParentWorkflowId is NULL":t),fo=k([y],([t])=>t.params.namespace),wo=k([fo,lo,so,st,co],([t,o,n,r,e])=>({namespace:t,query:o,refresh:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})),Eo=t=>{yo.set({...t,newCount:0})},mo=t=>wo.subscribe(({namespace:o,query:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})=>{ao(ho,ko,async()=>{const{workflows:a,error:i}=await F(o,{query:n});if(t(a),r&&!h(io)){const c=await Ft(o,n);Eo(c)}i?e?D.set(A("workflows.workflows-error-querying")):D.set(i):D.set("")})}),tn=_(""),ko=_(!0),ho=_(!0),yo=_({count:0,newCount:0}),D=_(""),on=yt([],mo),nn=_("");export{Ho as A,nn as B,to as C,ho as D,ko as E,D as F,on as G,Jo as H,Bo as a,$o as b,tn as c,Zo as d,Ko as e,Fo as f,Mo as g,Vo as h,st as i,Uo as j,N as k,Bt as l,qo as m,ct as n,Xo as o,io as p,lo as q,so as r,oo as s,vo as t,zo as u,Qo as v,yo as w,Go as x,lt as y,jo as z};
