import{d as k,r as Pt,w as _}from"./entry.BrGPX4E7.js";import{p as y}from"./stores.DWDQ79Ol.js";import{t as A}from"./translate.BBe5dcco.js";import{v as rt,C as h}from"./scheduler.D6mQsyhd.js";import{r as m,a as w,i as it,b as It,p as Tt,c as _t,d as gt,e as At,m as U}from"./route-for-api.C5eJDV1b.js";import{A as x}from"./workflow-actions.TBME1SPK.js";import{b as St,c as xt,a as et}from"./decode-payload.dGfDYeHG.js";import{f as bt,g as Wt,h as Lt}from"./screaming-enums.w0zEi9dM.js";import{s as Ct,c as st,t as Y}from"./versions.CfiJFoj-.js";import{s as Rt}from"./index.IbEqUFKZ.js";import{a as $}from"./auth-user.BeMM7WeJ.js";import{c as Yt}from"./events.B-X_Hiqk.js";import{e as L,s as Nt}from"./encode-payload.DyxzSGS2.js";import{p as pt}from"./paginated.Dd8K_jAO.js";import{s as T}from"./parse-with-big-int.Dyr6jPtv.js";import{i as Dt,c as Ut,d as at,e as $t}from"./format-time.Dn4a2B__.js";import{a as Ot}from"./events-service.Dyb0OugF.js";import{v as Ft}from"./toaster.B5k4rAIX.js";const vt=async(t,o,n=fetch)=>{let r=0;try{const e=m("workflows.count",{namespace:t}),a=await w(e,{params:o?{query:o}:{},onError:rt,handleError:rt,request:n});r=parseInt((a==null?void 0:a.count)||"0")}catch{}return{count:r}},Oo=async({namespace:t,query:o})=>{const n="GROUP BY ExecutionStatus",r=m("workflows.count",{namespace:t}),{count:e,groups:a}=await w(r,{params:{query:o?`${o} ${n}`:`${n}`},notifyOnError:!1});return{count:e??"0",groups:a}},Fo=async({namespace:t})=>{const o='TemporalNamespaceDivision="TemporalScheduler" AND ExecutionStatus="Running"',n=m("workflows.count",{namespace:t}),{count:r}=await w(n,{params:{query:o},notifyOnError:!1});return r??"0"},Bt=(t=Ct)=>!h(t).disableWriteActions,qt=(t=[])=>t.map(o=>{const n=Rt(o,!0),r=o.activityId;return{...n,id:r}}),Vt=t=>t?t.map(o=>({...o,state:Wt(o.state)})):[],Qt=t=>t?t.map(o=>({...o,state:Lt(o.state)})):[],Gt=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((n,[r,e])=>({...n,[r]:St(e)}),{})},O=t=>{var V,Q,G,z,X,j,M,K,H,J,Z,tt,ot,nt;const o=Gt(t.workflowExecutionInfo.searchAttributes),n=t.workflowExecutionInfo.memo,r=t.workflowExecutionInfo.type.name,e=t.workflowExecutionInfo.execution.workflowId,a=t.workflowExecutionInfo.execution.runId,i=t.workflowExecutionInfo.startTime,u=t.workflowExecutionInfo.closeTime,s=t.workflowExecutionInfo.executionTime,f=bt(t.workflowExecutionInfo.status),l=f==="Running",d=t.workflowExecutionInfo.historyLength,c=t.workflowExecutionInfo.historySizeBytes,E=`/workflows/${e}/${a}`,P=((Q=(V=t==null?void 0:t.executionConfig)==null?void 0:V.taskQueue)==null?void 0:Q.name)||((G=t==null?void 0:t.workflowExecutionInfo)==null?void 0:G.taskQueue),S=(z=t==null?void 0:t.workflowExecutionInfo)==null?void 0:z.mostRecentWorkerVersionStamp,g=(X=t==null?void 0:t.workflowExecutionInfo)==null?void 0:X.assignedBuildId,b=(j=t==null?void 0:t.workflowExecutionInfo)==null?void 0:j.parentNamespaceId,W=(M=t==null?void 0:t.workflowExecutionInfo)==null?void 0:M.parentExecution,v=t.workflowExecutionInfo.stateTransitionCount,I=(K=t.executionConfig)==null?void 0:K.defaultWorkflowTaskTimeout,wt=qt(t.pendingActivities),Et=(t==null?void 0:t.pendingChildren)??[],mt=Vt(t==null?void 0:t.pendingNexusOperations),kt=t==null?void 0:t.pendingWorkflowTask,ht=Qt(t==null?void 0:t.callbacks),yt=(H=t.workflowExecutionInfo)==null?void 0:H.rootExecution;let B,q;return(J=t==null?void 0:t.executionConfig)!=null&&J.userMetadata&&(B=(tt=(Z=t==null?void 0:t.executionConfig)==null?void 0:Z.userMetadata)==null?void 0:tt.summary,q=(nt=(ot=t==null?void 0:t.executionConfig)==null?void 0:ot.userMetadata)==null?void 0:nt.details),{name:r,id:e,runId:a,startTime:i,endTime:u,executionTime:s,status:f,historyEvents:d,historySizeBytes:c,searchAttributes:o,memo:n,rootExecution:yt,url:E,taskQueue:P,assignedBuildId:g,mostRecentWorkerVersionStamp:S,pendingActivities:wt,pendingChildren:Et,pendingNexusOperations:mt,pendingWorkflowTask:kt,callbacks:ht,summary:B,details:q,parentNamespaceId:b,parent:W,stateTransitionCount:v,isRunning:l,defaultWorkflowTaskTimeout:I,get canBeTerminated(){return l&&Bt()}}},N=t=>(t.executions||[]).map(o=>O({workflowExecutionInfo:o})),zt=(t,o)=>{var n;return((n=t==null?void 0:t.visibilityStore)==null?void 0:n.includes("elasticsearch"))||it(o,"1.19")},Xt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},p=k([y],([t])=>{var o,n,r;return(r=(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),ct=k([st,Y,p],([t,o,n])=>zt(t,o)||n);k([st,p],([t,o])=>Xt(t)||o);var C=(t=>(t[t.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL=1]="RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL",t[t.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE=2]="RESET_REAPPLY_EXCLUDE_TYPE_UPDATE",t))(C||{}),R=(t=>(t[t.RESET_REAPPLY_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_TYPE_SIGNAL=1]="RESET_REAPPLY_TYPE_SIGNAL",t[t.RESET_REAPPLY_TYPE_NONE=2]="RESET_REAPPLY_TYPE_NONE",t[t.RESET_REAPPLY_TYPE_ALL_ELIGIBLE=3]="RESET_REAPPLY_TYPE_ALL_ELIGIBLE",t))(R||{});const jt={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Mt=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Kt=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Ht=t=>{if(typeof t!="string")return!1;for(const o of Mt)if(o===t)return!0;return!1},Jt=(t,o,n)=>{const r=jt[t];return o==="All"?"":Dt(o)||Ut(o)?n||h(ct)?`${r} > "${at(o)}"`:`${r} BETWEEN "${at(o)}" AND "${$t()}"`:`${r}="${o}"`},Zt=(t,o)=>Object.entries(t).map(([n,r])=>{if(Ht(n)&&Kt(r))return Jt(n,r,o)}).filter(Boolean),ut=(t,o=!1)=>Zt(t,o).join(" and ");function to(t){console.error("Unhandled action:",t)}const oo=(t,o)=>{let n;switch(t){case x.Cancel:n=A("workflows.canceled");break;case x.Reset:n=A("workflows.reset");break;case x.Terminate:n=A("workflows.terminated");break;default:to(t)}return o?A("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:o}):A("workflows.workflow-action-reason-placeholder",{action:n})},lt=({action:t,reason:o,email:n})=>{const r=oo(t,n);return o?[o.trim(),r].join(" "):r},F=async(t,o,n=fetch,r=!1)=>{const e=o.query||ut(o,r);let a;try{a=decodeURIComponent(e)}catch{a=e}const i=r?"workflows.archived":"workflows";let u="";const s=c=>{var E,P;_t(c),(E=c==null?void 0:c.body)!=null&&E.message||c!=null&&c.status?u=((P=c==null?void 0:c.body)==null?void 0:P.message)??`Error fetching workflows: ${c.status}: ${c.statusText}`:u="Error fetching workflows: Server failed to respond"},f=m(i,{namespace:t}),{executions:l,nextPageToken:d}=await w(f,{params:{query:a},onError:s,handleError:s,request:n})??{executions:[],nextPageToken:""};return{workflows:N({executions:l}),nextPageToken:String(d),error:u}},vo=async({namespace:t,workflowId:o,url:n},r=fetch)=>{var l;const e="workflows",a=n??It(t),i=Tt(e,{namespace:t}),u=a+i,{executions:s}=await w(u,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:r})??{executions:[]},f=(l=N({executions:s}))==null?void 0:l[0];return{runId:f==null?void 0:f.runId}},Bo=async(t,o=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const a=u=>{(gt(u)||At(u))&&(e=!1)},i=m(r,{namespace:t});return await w(i,{params:{pageSize:"1"},onError:a,handleError:a,request:o}),{authorized:e}},qo=async(t,o,n=fetch)=>F(t,o,n,!0);async function ft(t,o=fetch){const n=m("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(n,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(r=>({workflow:O(r)})).catch(r=>({error:r}))}async function Vo({workflow:t,namespace:o,reason:n}){const r=m("workflow.terminate",{namespace:o,workflowId:t.id}),e=h($).email,a=lt({reason:n,action:x.Terminate,email:e});return await w(r,{options:{method:"POST",body:T({reason:a,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Qo({namespace:t,workflow:{id:o,runId:n}},r=fetch){const e=m("workflow.cancel",{namespace:t,workflowId:o});return w(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Go({namespace:t,workflow:{id:o,runId:n},name:r,input:e,encoding:a}){const i=m("workflow.signal",{namespace:t,workflowId:o,signalName:r}),u=await L(e,a),s=h(y).data.settings,f=(s==null?void 0:s.version)??"",d=it(f,"2.22")?{signalName:r,workflowExecution:{workflowId:o,runId:n},input:{payloads:u}}:{signalName:r,input:{payloads:u},params:{"execution.runId":n}};return w(i,{notifyOnError:!1,options:{method:"POST",body:T(d)}})}async function zo({namespace:t,workflow:{id:o,runId:n},eventId:r,reason:e,includeSignals:a,excludeSignals:i,excludeUpdates:u}){const s=m("workflow.reset",{namespace:t,workflowId:o}),f=h($).email,l=lt({action:x.Reset,reason:e,email:f}),d={workflowExecution:{workflowId:o,runId:n},workflowTaskFinishEventId:r,requestId:Ft(),reason:l};if(h(p)||U("1.24.0",h(Y))){const c=[];!i&&!u&&c.push(C.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED),i&&c.push(C.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL),u&&c.push(C.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE),d.resetReapplyExcludeTypes=c,d.resetReapplyType=R.RESET_REAPPLY_TYPE_ALL_ELIGIBLE}else{let c;a?c=R.RESET_REAPPLY_TYPE_SIGNAL:c=R.RESET_REAPPLY_TYPE_NONE,d.resetReapplyType=c}return w(s,{notifyOnError:!1,options:{method:"POST",body:T(d)},params:{"execution.runId":n}})}async function Xo(t,o=fetch){const n=e=>{console.error(e)},r=m("workflow",t);return w(r,{request:o,onError:n,handleError:n}).then(O)}async function jo(t,o,n){if(!h(dt))return[];try{let r=`ParentWorkflowId = "${o}"`;n&&(r+=` AND ParentRunId = "${n}"`);const{workflows:e}=await F(t,{query:r});return e}catch{return[]}}const no=t=>{if(!t.length)return{};const o={};return t.forEach(n=>{o[n.label]=Nt(n.value)}),o};async function Mo({namespace:t,workflowId:o,taskQueue:n,workflowType:r,input:e,summary:a,details:i,encoding:u,searchAttributes:s}){const f=m("workflow",{namespace:t,workflowId:o});let l,d,c;if(e)try{l=await L(e,u)}catch{throw new Error("Could not encode input for starting workflow")}try{a&&(d=(await L(T(a),"json/plain"))[0]),i&&(c=(await L(T(i),"json/plain"))[0])}catch{console.error("Could not encode summary or details for starting workflow")}const E=T({workflowId:o,taskQueue:{name:n},workflowType:{name:r},input:l?{payloads:l}:null,userMetadata:{summary:d,details:c},searchAttributes:s.length===0?null:{indexedFields:{...no(s)}}});return w(f,{notifyOnError:!1,options:{method:"POST",body:E}})}const Ko=async({namespace:t,workflowType:o,workflowId:n})=>{var a,i,u;const r=s=>{console.error(s)},e={input:"",searchAttributes:void 0,summary:"",details:""};try{let s="";o&&n?s=`WorkflowType = "${o}" AND WorkflowId = "${n}"`:o?s=`WorkflowType = "${o}"`:n&&(s=`WorkflowId = "${n}"`);const f=m("workflows",{namespace:t}),l=await w(f,{params:{query:s,pageSize:"1"},handleError:r});if(!((a=l==null?void 0:l.executions)!=null&&a[0]))return e;const d=N(l)[0],c={namespace:t,workflowId:d.id,runId:d.runId},{workflow:E}=await ft(c),S=await Ot(c),g=await xt((i=S==null?void 0:S.attributes)==null?void 0:i.input,t,h(y).data.settings,h($).accessToken);let b="";if(E.summary){const I=await et(E.summary);typeof I=="string"&&(b=I)}let W="";if(E.details){const I=await et(E.details);typeof I=="string"&&(W=I)}return{input:g!=null&&g.payloads?T(g.payloads[0]):"",searchAttributes:(u=E==null?void 0:E.searchAttributes)==null?void 0:u.indexedFields,summary:b,details:W}}catch{return e}},ro=(t,o)=>{const n=new Map;o.forEach(e=>{if(e.parent){const a=`${e.parent.workflowId}:${e.parent.runId}`,i=n.get(a)||[];i.push(e),n.set(a,i)}});const r=(e,a)=>{const i=`${e.id}:${e.runId}`,u=n.get(i)||[],s={workflow:e,children:[],rootPaths:[...a,{runId:e.runId,workflowId:e.id}]};return s.children=u.map(f=>r(f,s.rootPaths)),s};return r(t,[])};async function Ho(t,o,n){let r=`RootWorkflowId = "${o}"`;n&&(r+=` AND RootRunId = "${n}"`);const e=await ft({namespace:t,workflowId:o,runId:n}),a=await eo(t,{query:r});return ro(e==null?void 0:e.workflow,a)}const eo=async(t,o,n=fetch,r=!1)=>{const e=o.query||ut(o,r);let a;try{a=decodeURIComponent(e)}catch{a=e}const i=m("workflows",{namespace:t}),{executions:u}=await pt(async s=>w(i,{token:s,request:n,params:{query:a}}));return N({executions:u})},ao=300,io=async(t,o,n)=>{o.set(!0);try{await n()}catch(r){console.error(r)}t.set(!1),setTimeout(()=>{o.set(!1)},ao)},so=k([y],([t])=>{var o,n,r;return!!((r=(n=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:n.capabilities)!=null&&r.countGroupByExecutionStatus)}),Jo=k([y,Y],([t,o])=>{var e,a,i;const n=U("1.23.0",o),r=!!((i=(a=(e=t.data)==null?void 0:e.systemInfo)==null?void 0:a.capabilities)!=null&&i.prefixSearch);return n||r}),co=_(0),uo=k([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.hideWorkflowQueryErrors}),Zo=k([y],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.refreshWorkflowCountsDisabled}),dt=k([p,Y],([t,o])=>t||U("1.23.0",o)),lo=k([y],([t])=>t.url.searchParams.get("query")),fo=k([lo,dt,Yt],([t,o,n])=>o&&!n?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),wo=k([y],([t])=>t.params.namespace),Eo=k([wo,fo,co,ct,uo],([t,o,n,r,e])=>({namespace:t,query:o,refresh:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})),mo=t=>{Po.set({...t,newCount:0})},ko=t=>Eo.subscribe(({namespace:o,query:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})=>{io(yo,ho,async()=>{const{workflows:a,error:i}=await F(o,{query:n});if(t(a),r&&!h(so)){const u=await vt(o,n);mo(u)}i?e?D.set(A("workflows.workflows-error-querying")):D.set(i):D.set("")})}),tn=_(""),ho=_(!0),yo=_(!0),Po=_({count:0,newCount:0}),D=_(""),on=Pt([],ko),nn=_("");export{Jo as A,nn as B,oo as C,dt as D,on as E,yo as F,ho as G,D as H,Bo as a,Oo as b,tn as c,Zo as d,Ko as e,vo as f,Mo as g,Qo as h,ct as i,Fo as j,p as k,Bt as l,qo as m,ut as n,zo as o,Go as p,fo as q,co as r,no as s,Vo as t,ft as u,Xo as v,Po as w,so as x,jo as y,Ho as z};
