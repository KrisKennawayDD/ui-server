import{d as m,r as it,w as I}from"./entry.CTitIrOR.js";import{p as h}from"./stores.B9baqaLW.js";import{t as T}from"./translate.BBe5dcco.js";import{v as q,C as k}from"./scheduler.C46pS-76.js";import{r as E,a as w,i as G,b as ct,p as ut,c as ft,d as lt,e as dt,m as W}from"./route-for-api.DZMqk1AK.js";import{A as _}from"./workflow-actions.TBME1SPK.js";import{b as wt,c as Et}from"./decode-payload.dQCMp5o9.js";import{f as mt,g as kt,h as ht}from"./screaming-enums.w0zEi9dM.js";import{s as Pt,c as z,t as b}from"./versions.q-eOaY-G.js";import{s as yt}from"./index.BJoUy-lU.js";import{a as C}from"./auth-user.Dcw-H6R3.js";import{c as It}from"./events.CxxhuHVe.js";import{e as X,s as Tt}from"./encode-payload.CRpV0CRv.js";import{s as A}from"./parse-with-big-int.BKSBwM2t.js";import{i as _t,c as At,d as Q,e as St}from"./format-time.6TuExJAg.js";import{a as gt}from"./events-service.D7-eDR8J.js";import{v as bt}from"./toaster.t5-1zJgZ.js";const xt=async(t,o,n=fetch)=>{let r=0;try{const e=E("workflows.count",{namespace:t}),s=await w(e,{params:o?{query:o}:{},onError:q,handleError:q,request:n});r=parseInt((s==null?void 0:s.count)||"0")}catch{}return{count:r}},Ao=async({namespace:t,query:o})=>{const n="GROUP BY ExecutionStatus",r=E("workflows.count",{namespace:t}),{count:e,groups:s}=await w(r,{params:{query:o?`${o} ${n}`:`${n}`},notifyOnError:!1});return{count:e??"0",groups:s}},So=async({namespace:t})=>{const o='TemporalNamespaceDivision="TemporalScheduler" AND ExecutionStatus="Running"',n=E("workflows.count",{namespace:t}),{count:r}=await w(n,{params:{query:o},notifyOnError:!1});return r??"0"},Lt=(t=Pt)=>!k(t).disableWriteActions,Wt=(t=[])=>t.map(o=>{const n=yt(o,!0),r=o.activityId;return{...n,id:r}}),Ct=t=>t?t.map(o=>({...o,state:kt(o.state)})):[],Rt=t=>t?t.map(o=>({...o,state:ht(o.state)})):[],Yt=t=>!t||!t.indexedFields?{}:{indexedFields:Object.entries(t.indexedFields).reduce((n,[r,e])=>({...n,[r]:wt(e)}),{})},R=t=>{var D,O,U,F,v,B,$,V;const o=Yt(t.workflowExecutionInfo.searchAttributes),n=t.workflowExecutionInfo.memo,r=t.workflowExecutionInfo.type.name,e=t.workflowExecutionInfo.execution.workflowId,s=t.workflowExecutionInfo.execution.runId,a=t.workflowExecutionInfo.startTime,u=t.workflowExecutionInfo.closeTime,i=t.workflowExecutionInfo.executionTime,f=mt(t.workflowExecutionInfo.status),l=f==="Running",d=t.workflowExecutionInfo.historyLength,c=t.workflowExecutionInfo.historySizeBytes,P=`/workflows/${e}/${s}`,y=((O=(D=t==null?void 0:t.executionConfig)==null?void 0:D.taskQueue)==null?void 0:O.name)||((U=t==null?void 0:t.workflowExecutionInfo)==null?void 0:U.taskQueue),p=(F=t==null?void 0:t.workflowExecutionInfo)==null?void 0:F.mostRecentWorkerVersionStamp,J=(v=t==null?void 0:t.workflowExecutionInfo)==null?void 0:v.assignedBuildId,M=(B=t==null?void 0:t.workflowExecutionInfo)==null?void 0:B.parentNamespaceId,Z=($=t==null?void 0:t.workflowExecutionInfo)==null?void 0:$.parentExecution,tt=t.workflowExecutionInfo.stateTransitionCount,ot=(V=t.executionConfig)==null?void 0:V.defaultWorkflowTaskTimeout,nt=Wt(t.pendingActivities),rt=(t==null?void 0:t.pendingChildren)??[],et=Ct(t==null?void 0:t.pendingNexusOperations),st=t==null?void 0:t.pendingWorkflowTask,at=Rt(t==null?void 0:t.callbacks);return{name:r,id:e,runId:s,startTime:a,endTime:u,executionTime:i,status:f,historyEvents:d,historySizeBytes:c,searchAttributes:o,memo:n,url:P,taskQueue:y,assignedBuildId:J,mostRecentWorkerVersionStamp:p,pendingActivities:nt,pendingChildren:rt,pendingNexusOperations:et,pendingWorkflowTask:st,callbacks:at,parentNamespaceId:M,parent:Z,stateTransitionCount:tt,isRunning:l,defaultWorkflowTaskTimeout:ot,get canBeTerminated(){return l&&Lt()}}},Y=t=>(t.executions||[]).map(o=>R({workflowExecutionInfo:o})),Nt=(t,o)=>{var n;return((n=t==null?void 0:t.visibilityStore)==null?void 0:n.includes("elasticsearch"))||G(o,"1.19")},pt=t=>{var o;return(o=t==null?void 0:t.visibilityStore)==null?void 0:o.includes("elasticsearch")},x=m([h],([t])=>{var o,n,r;return(r=(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),j=m([z,b,x],([t,o,n])=>Nt(t,o)||n);m([z,x],([t,o])=>pt(t)||o);var S=(t=>(t[t.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL=1]="RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL",t[t.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE=2]="RESET_REAPPLY_EXCLUDE_TYPE_UPDATE",t))(S||{}),g=(t=>(t[t.RESET_REAPPLY_TYPE_UNSPECIFIED=0]="RESET_REAPPLY_TYPE_UNSPECIFIED",t[t.RESET_REAPPLY_TYPE_SIGNAL=1]="RESET_REAPPLY_TYPE_SIGNAL",t[t.RESET_REAPPLY_TYPE_NONE=2]="RESET_REAPPLY_TYPE_NONE",t[t.RESET_REAPPLY_TYPE_ALL_ELIGIBLE=3]="RESET_REAPPLY_TYPE_ALL_ELIGIBLE",t))(g||{});const Dt={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},Ot=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Ut=t=>!(t===null||t===void 0||t===""||typeof t=="string"&&t==="undefined"),Ft=t=>{if(typeof t!="string")return!1;for(const o of Ot)if(o===t)return!0;return!1},vt=(t,o,n)=>{const r=Dt[t];return o==="All"?"":_t(o)||At(o)?n||k(j)?`${r} > "${Q(o)}"`:`${r} BETWEEN "${Q(o)}" AND "${St()}"`:`${r}="${o}"`},Bt=(t,o)=>Object.entries(t).map(([n,r])=>{if(Ft(n)&&Ut(r))return vt(n,r,o)}).filter(Boolean),$t=(t,o=!1)=>Bt(t,o).join(" and ");function Vt(t){console.error("Unhandled action:",t)}const qt=(t,o)=>{let n;switch(t){case _.Cancel:n=T("workflows.canceled");break;case _.Reset:n=T("workflows.reset");break;case _.Terminate:n=T("workflows.terminated");break;default:Vt(t)}return o?T("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:o}):T("workflows.workflow-action-reason-placeholder",{action:n})},K=({action:t,reason:o,email:n})=>{const r=qt(t,n);return o?[o.trim(),r].join(" "):r},N=async(t,o,n=fetch,r=!1)=>{const e=o.query||$t(o,r);let s;try{s=decodeURIComponent(e)}catch{s=e}const a=r?"workflows.archived":"workflows";let u="";const i=c=>{var P,y;ft(c),(P=c==null?void 0:c.body)!=null&&P.message||c!=null&&c.status?u=((y=c==null?void 0:c.body)==null?void 0:y.message)??`Error fetching workflows: ${c.status}: ${c.statusText}`:u="Error fetching workflows: Server failed to respond"},f=E(a,{namespace:t}),{executions:l,nextPageToken:d}=await w(f,{params:{query:s},onError:i,handleError:i,request:n})??{executions:[],nextPageToken:""};return{workflows:Y({executions:l}),nextPageToken:String(d),error:u}},go=async({namespace:t,workflowId:o,url:n},r=fetch)=>{var l;const e="workflows",s=n??ct(t),a=ut(e,{namespace:t}),u=s+a,{executions:i}=await w(u,{params:{query:`WorkflowId="${o}"`,pageSize:"1"},request:r})??{executions:[]},f=(l=Y({executions:i}))==null?void 0:l[0];return{runId:f==null?void 0:f.runId}},bo=async(t,o=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const s=u=>{(lt(u)||dt(u))&&(e=!1)},a=E(r,{namespace:t});return await w(a,{params:{pageSize:"1"},onError:s,handleError:s,request:o}),{authorized:e}},xo=async(t,o,n=fetch)=>N(t,o,n,!0);async function Lo(t,o=fetch){const n=E("workflow",{namespace:t.namespace,workflowId:t.workflowId});return w(n,{request:o,notifyOnError:!1,params:{"execution.runId":t.runId}}).then(r=>({workflow:R(r)})).catch(r=>({error:r}))}async function Wo({workflow:t,namespace:o,reason:n}){const r=E("workflow.terminate",{namespace:o,workflowId:t.id}),e=k(C).email,s=K({reason:n,action:_.Terminate,email:e});return await w(r,{options:{method:"POST",body:A({reason:s,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":t.runId}})}async function Co({namespace:t,workflow:{id:o,runId:n}},r=fetch){const e=E("workflow.cancel",{namespace:t,workflowId:o});return w(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function Ro({namespace:t,workflow:{id:o,runId:n},name:r,input:e,encoding:s}){const a=E("workflow.signal",{namespace:t,workflowId:o,signalName:r}),u=await X(e,s),i=k(h).data.settings,f=(i==null?void 0:i.version)??"",d=G(f,"2.22")?{signalName:r,workflowExecution:{workflowId:o,runId:n},input:{payloads:u}}:{signalName:r,input:{payloads:u},params:{"execution.runId":n}};return w(a,{notifyOnError:!1,options:{method:"POST",body:A(d)}})}async function Yo({namespace:t,workflow:{id:o,runId:n},eventId:r,reason:e,includeSignals:s,excludeSignals:a,excludeUpdates:u}){const i=E("workflow.reset",{namespace:t,workflowId:o}),f=k(C).email,l=K({action:_.Reset,reason:e,email:f}),d={workflowExecution:{workflowId:o,runId:n},workflowTaskFinishEventId:r,requestId:bt(),reason:l};if(k(x)||W("1.24.0",k(b))){const c=[];!a&&!u&&c.push(S.RESET_REAPPLY_EXCLUDE_TYPE_UNSPECIFIED),a&&c.push(S.RESET_REAPPLY_EXCLUDE_TYPE_SIGNAL),u&&c.push(S.RESET_REAPPLY_EXCLUDE_TYPE_UPDATE),d.resetReapplyExcludeTypes=c,d.resetReapplyType=g.RESET_REAPPLY_TYPE_ALL_ELIGIBLE}else{let c;s?c=g.RESET_REAPPLY_TYPE_SIGNAL:c=g.RESET_REAPPLY_TYPE_NONE,d.resetReapplyType=c}return w(i,{notifyOnError:!1,options:{method:"POST",body:A(d)},params:{"execution.runId":n}})}async function No(t,o=fetch){const n=e=>{console.error(e)},r=E("workflow",t);return w(r,{request:o,onError:n,handleError:n}).then(R)}async function po(t,o,n){if(!k(H))return[];try{let r=`ParentWorkflowId = "${o}"`;n&&(r+=` AND ParentRunId = "${n}"`);const{workflows:e}=await N(t,{query:r});return e}catch{return[]}}const Qt=t=>{if(!t.length)return{};const o={};return t.forEach(n=>{o[n.attribute]=Tt(String(n.value))}),o};async function Do({namespace:t,workflowId:o,taskQueue:n,workflowType:r,input:e,encoding:s,searchAttributes:a}){const u=E("workflow",{namespace:t,workflowId:o});let i;if(e)try{i=await X(e,s)}catch{console.error("Could not decode input for starting workflow")}const f=A({workflowId:o,taskQueue:{name:n},workflowType:{name:r},input:i?{payloads:i}:null,searchAttributes:a.length===0?null:{indexedFields:{...Qt(a)}}});return w(u,{notifyOnError:!1,options:{method:"POST",body:f}})}const Oo=async({namespace:t,workflowType:o,workflowId:n})=>{var s,a,u;const r=i=>{console.error(i)},e={input:"",searchAttributes:void 0};try{let i="";o&&n?i=`WorkflowType = "${o}" AND WorkflowId = "${n}"`:o?i=`WorkflowType = "${o}"`:n&&(i=`WorkflowId = "${n}"`);const f=E("workflows",{namespace:t}),l=await w(f,{params:{query:i,pageSize:"1"},handleError:r});if(!((s=l==null?void 0:l.executions)!=null&&s[0]))return e;const d=Y(l)[0],P=await gt({namespace:t,workflowId:d.id,runId:d.runId}),y=await Et((a=P==null?void 0:P.attributes)==null?void 0:a.input,t,k(h).data.settings,k(C).accessToken);return{input:A(y==null?void 0:y.payloads[0]),searchAttributes:(u=d==null?void 0:d.searchAttributes)==null?void 0:u.indexedFields}}catch{return e}},Gt=300,zt=async(t,o,n)=>{o.set(!0);try{await n()}catch(r){console.error(r)}t.set(!1),setTimeout(()=>{o.set(!1)},Gt)},Xt=m([h],([t])=>{var o,n,r;return!!((r=(n=(o=t.data)==null?void 0:o.systemInfo)==null?void 0:n.capabilities)!=null&&r.countGroupByExecutionStatus)}),Uo=m([h,b],([t,o])=>{var e,s,a;const n=W("1.23.0",o),r=!!((a=(s=(e=t.data)==null?void 0:e.systemInfo)==null?void 0:s.capabilities)!=null&&a.prefixSearch);return n||r}),jt=I(0),Kt=m([h],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.hideWorkflowQueryErrors}),Fo=m([h],([t])=>{var o,n;return(n=(o=t.data)==null?void 0:o.settings)==null?void 0:n.refreshWorkflowCountsDisabled}),H=m([x,b],([t,o])=>t||W("1.23.0",o)),Ht=m([h],([t])=>t.url.searchParams.get("query")),Jt=m([Ht,H,It],([t,o,n])=>o&&!n?t?`ParentWorkflowId is NULL AND ${t}`:"ParentWorkflowId is NULL":t),Mt=m([h],([t])=>t.params.namespace),Zt=m([Mt,Jt,jt,j,Kt],([t,o,n,r,e])=>({namespace:t,query:o,refresh:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})),to=t=>{eo.set({...t,newCount:0})},oo=t=>Zt.subscribe(({namespace:o,query:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})=>{zt(ro,no,async()=>{const{workflows:s,error:a}=await N(o,{query:n});if(t(s),r&&!k(Xt)){const u=await xt(o,n);to(u)}a?e?L.set(T("workflows.workflows-error-querying")):L.set(a):L.set("")})}),vo=I(""),no=I(!0),ro=I(!0),eo=I({count:0,newCount:0}),L=I(""),Bo=it([],oo),$o=I("");export{$o as A,qt as B,H as C,Bo as D,ro as E,no as F,L as G,bo as a,Ao as b,vo as c,Fo as d,Oo as e,go as f,Do as g,Co as h,j as i,po as j,So as k,x as l,Lt as m,xo as n,$t as o,Yo as p,Jt as q,jt as r,Qt as s,Wo as t,Ro as u,Lo as v,eo as w,No as x,Xt as y,Uo as z};
